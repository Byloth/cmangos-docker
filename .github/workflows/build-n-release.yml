name: Docker images build & release
on:
  push:
  workflow_dispatch:

jobs:
  builder-build:
    name: "`builder` building process"
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: "1"

    steps:
      - name: Clone the repository
        uses: actions/checkout@v2
      - name: Configure the Docker environment
        uses: Byloth/docker-setup-action@v1
        with:
          registry: ghcr.io

      - name: Login to the GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull the Docker cache images
        run: |
          docker pull "${{ env.DOCKER_IMAGE }}/builder:${{ env.GITHUB_REF_SLUG }}" || true & \
          docker pull "${{ env.DOCKER_IMAGE }}/builder:${{ env.GITHUB_SHORT_SHA }}" || true

      - name: Build the Docker images
        run: |
          docker build --build-arg THREADS="2" \
                       --tag "${{ env.DOCKER_IMAGE }}/builder:${{ env.GITHUB_REF_SLUG }}" \
                       --tag "${{ env.DOCKER_IMAGE }}/builder:${{ env.GITHUB_SHORT_SHA }}" \
            \
            ./builder/

      - name: Push the Docker images
        run: |
          docker push "${{ env.DOCKER_IMAGE }}/builder:${{ env.GITHUB_REF_SLUG }}" & \
          docker push "${{ env.DOCKER_IMAGE }}/builder:${{ env.GITHUB_SHORT_SHA }}"

  runner-build:
    name: "`runner` building process"
    needs: builder-build
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: "1"

    steps:
      - name: Clone the repository
        uses: actions/checkout@v2
      - name: Configure the Docker environment
        uses: Byloth/docker-setup-action@v1
        with:
          registry: ghcr.io

      - name: Login to the GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull the CMaNGOS builder image
        run: |
          docker pull "${{ env.DOCKER_IMAGE }}/builder:${{ env.GITHUB_SHORT_SHA }}" && \
          docker tag "${{ env.DOCKER_IMAGE }}/builder:${{ env.GITHUB_SHORT_SHA }}" \
                     "cmangos/builder:tbc"

      - name: Pull the Docker cache images
        run: |
          docker pull "${{ env.DOCKER_IMAGE }}/runner:${{ env.GITHUB_REF_SLUG }}" || true & \
          docker pull "${{ env.DOCKER_IMAGE }}/runner:${{ env.GITHUB_SHORT_SHA }}" || true

      - name: Build the Docker images
        run: |
          docker build --tag "${{ env.DOCKER_IMAGE }}/runner:${{ env.GITHUB_REF_SLUG }}" \
                       --tag "${{ env.DOCKER_IMAGE }}/runner:${{ env.GITHUB_SHORT_SHA }}" \
            \
            ./runner/

      - name: Push the Docker images
        run: |
          docker push "${{ env.DOCKER_IMAGE }}/runner:${{ env.GITHUB_REF_SLUG }}" & \
          docker push "${{ env.DOCKER_IMAGE }}/runner:${{ env.GITHUB_SHORT_SHA }}"
